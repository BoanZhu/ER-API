<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/html">
<head>
    <meta charset="UTF-8">
    <title>API image</title>
    <script type="text/javascript" src="go.js"></script>
    <script type="text/javascript" src="Figures.js"></script>
</head>
<body>
<div id="image"></div>
<div id="d"></div>
</body>
<script id="code">
    var modelJson = "{ \"class\": \"GraphLinksModel\",\n" +
        "  \"linkFromPortIdProperty\": \"fromPort\",\n" +
        "  \"linkToPortIdProperty\": \"toPort\",\n" +
        "  \"nodeDataArray\": [\n" +
        "{\"name\":\"New Entity0\",\"category\":\"entity\",\"from\":true,\"to\":true,\"key\":-1,\"location\":{\"class\":\"go.Point\",\"x\":-52.728240966796875,\"y\":11.010009765625},\"connectedEntity\":[]},\n" +
        "{\"name\":\"New Entity1\",\"category\":\"entity\",\"from\":true,\"to\":true,\"key\":-2,\"location\":{\"class\":\"go.Point\",\"x\":210.14208984375,\"y\":-150.13616943359375},\"connectedEntity\":[]},\n" +
        "{\"name\":\"Subset02\",\"category\":\"Subset\",\"location\":{\"class\":\"go.Point\",\"x\":-178.40844923601026,\"y\":200.83497377711467},\"entityId\":-1,\"key\":862,\"connectedEntity\":[]},\n" +
        "{\"name\":\"WeakE03\",\"category\":\"WeakEntity\",\"location\":{\"class\":\"go.Point\",\"x\":-147.1244579941499,\"y\":-167.23034844663712},\"entityId\":-1,\"key\":318,\"connectedEntity\":[]},\n" +
        "{\"key\":\"955_test\",\"name\":\"test\",\"location\":{\"class\":\"go.Point\",\"x\":78.70692443847656,\"y\":-69.56307983398438},\"category\":\"relation\",\"from\":true,\"to\":true,\"entityList\":[-2,-1]}\n" +
        "],\n" +
        "  \"linkDataArray\": [\n" +
        "{\"from\":862,\"to\":-1,\"category\":\"subsetLink\",\"fromPort\":\"L\",\"toPort\":\"U\"},\n" +
        "{\"from\":-1,\"to\":318,\"toText\":\"1:1\",\"relation\":\"for\",\"category\":\"relationLink\",\"fromPort\":\"L\",\"toPort\":\"U\"},\n" +
        "{\"from\":-2,\"to\":\"955_test\",\"fromText\":\"1:1\",\"category\":\"entityLink\",\"fromPort\":\"L\",\"toPort\":\"R\"},\n" +
        "{\"from\":-1,\"to\":\"955_test\",\"fromText\":\"1:1\",\"category\":\"entityLink\",\"fromPort\":\"R\",\"toPort\":\"L\"}\n" +
        "]}";

    init();
    myDiagram.model = go.Model.fromJson(modelJson);
    var image = myDiagram.makeImageData({
        scale:1
    });
    console.log(image);
    document.getElementById("image").innerHTML =image;
    // document.getElementById("image").appendChild(image);
    function init(){
        // Common color
        const colors =
            {
                'lightblue': '#afd4fe',
                'lightgrey': '#a4a8ad',
                'lightyellow': '#fcffbe'
            }

// Common text styling
        function textStyle() {
            return {
                margin: 6,
                wrap: go.TextBlock.WrapFit,
                textAlign: "center",
                editable: true,
            }
        }

        const $ = go.GraphObject.make;  // for conciseness in defining templates
        myDiagram = $(go.Diagram, 'd',  // must name or refer to the DIV HTML element
            {
                allowDelete: false,
                allowCopy: false,
                initialAutoScale: go.Diagram.Uniform,
                layout: $(go.ForceDirectedLayout, {isInitial: false, isOngoing: false}),
                "draggingTool.dragsLink": false,
                "draggingTool.isGridSnapEnabled": false,
                "undoManager.isEnabled": false,
                "maxSelectionCount": 1
            });

        /*
         4 ports
         */
        const leftPort = $(go.Panel, "Vertical", {row: 1, column: 0},
            $(go.Shape,
                {width: 3, height: 3, portId: "L",
                    toSpot: go.Spot.Left,fromSpot:go.Spot.Left,
                    fromLinkable: true,toLinkable: true}));
        const rightPort = $(go.Panel, "Vertical", {row: 1, column: 2},
            $(go.Shape,  // the "B" port
                {width: 3, height: 3, portId: "R", toSpot: go.Spot.Right,fromSpot:go.Spot.Right,
                    fromLinkable: true,toLinkable: true}));
        const bottomPort = $(go.Panel, "Horizontal", {row:2, column: 1},
            $(go.Shape,  // the "B" port
                {width: 3, height: 3, portId: "B", toSpot: go.Spot.Bottom,fromSpot:go.Spot.Bottom,
                    fromLinkable: true,toLinkable: true}));
        const topPort = $(go.Panel, "Vertical",{row: 0, column: 1},
            $(go.Shape,  // the "B" port
                {width: 3, height: 3, portId: "U", toSpot: go.Spot.Top,fromSpot:go.Spot.Top,
                    fromLinkable: true,toLinkable: true}));
        /*
            All Node(Entity+Attribute) templates
         */
        //strong entity template
        const entityTemplate =
            $(go.Node, "Table",  // the whole node panel
                {
                    locationObject: "BODY",
                    locationSpot: go.Spot.Center,
                    selectionObjectName: "BODY",
                    //contextMenu
                },
                {
                    locationSpot: go.Spot.Center,
                    selectionAdorned: true,
                    resizable: false,
                    layoutConditions: go.Part.LayoutStandard & ~go.Part.LayoutNodeSized,
                    isShadowed: true,
                    shadowOffset: new go.Point(3, 3),
                    shadowColor: colors.lightblue,
                },
                new go.Binding("location", "location").makeTwoWay(),
                // whenever the PanelExpanderButton changes the visible property of the "LIST" panel,
                // clear out any desiredSize set by the ResizingTool.
                new go.Binding("desiredSize", "visible", v => new go.Size(NaN, NaN)).ofObject("LIST"),
                // the body
                $(go.Panel, "Auto",
                    {
                        row: 1, column: 1, name: "BODY",
                    },
                    $(go.Shape, "RoundedRectangle",
                        {
                            fill: 'white',
                            portId: "",
                            stroke: colors.lightblue,
                            cursor: "pointer",
                            fromSpot: go.Spot.AllSides,
                            toSpot: go.Spot.AllSides,
                            strokeWidth: 3,
                            fromLinkableDuplicates: false, toLinkableDuplicates: false
                        }),
                    $(go.TextBlock, textStyle(),
                        {
                            row: 0, alignment: go.Spot.Center,
                            margin: new go.Margin(5, 24, 5, 2),  // leave room for Button
                            font: "bold 16px sans-serif",
                            editable: true
                        },
                        new go.Binding("text", "name").makeTwoWay()),
                    // new go.Binding("fromLinkable", "from").makeTwoWay(), new go.Binding("toLinkable", "to").makeTwoWay()
                ),// end Auto Panel Body
                // left port
                leftPort,rightPort,topPort,bottomPort
            );

        //relationNodeTemplate
        const relationTemplate =
            $(go.Node, "Table",
                {
                    locationObject: "BODY",
                    locationSpot:go.Spot.Center,
                    selectionObjectName: "BODY"
                },
                {
                    locationSpot: go.Spot.Center,
                    selectionAdorned: true,
                    resizable: false,
                    layoutConditions: go.Part.LayoutStandard & ~go.Part.LayoutNodeSized,
                    isShadowed: true,
                    shadowOffset: new go.Point(3, 3),
                    shadowColor: colors.lightblue,
                },
                new go.Binding("location", "location").makeTwoWay(),
                new go.Binding("desiredSize", "visible", v => new go.Size(NaN, NaN)).ofObject("LIST"),
                $(go.Panel,"Auto",
                    {row: 1, column: 1, name: "BODY"},
                    $(go.Shape, "Diamond",
                        {
                            fill: colors.lightyellow,
                            portId: "",
                            stroke: colors.lightblue,
                            cursor: "pointer",
                            fromSpot: go.Spot.AllSides,
                            toSpot: go.Spot.AllSides,
                            strokeWidth: 3,
                            width: 100,
                            height: 40,
                            fromLinkableDuplicates: false, toLinkableDuplicates: false
                        },
                        new go.Binding("fromLinkable", "from").makeTwoWay(), new go.Binding("toLinkable", "to").makeTwoWay()),
                    $(go.Panel, "Table",
                        { margin: 8, stretch: go.GraphObject.Fill },
                        $(go.RowColumnDefinition, { row: 0, sizing: go.RowColumnDefinition.None }),
                        $(go.TextBlock,textStyle(),
                            {
                                row: 0,
                                alignment: go.Spot.Center,
                                font: "bold 16px sans-serif",
                                editable: true
                            },
                            new go.Binding("text", "name").makeTwoWay()))
                ),
                $(go.Panel, "Vertical", {row: 1, column: 0},
                    $(go.Shape,
                        {width: 3, height: 3, portId: "L",
                            toSpot: go.Spot.Left,fromSpot:go.Spot.Left,
                            fromLinkable: true,toLinkable: true})),
                $(go.Panel, "Vertical", {row: 1, column: 2},
                    $(go.Shape,  // the "B" port
                        {width: 3, height: 3, portId: "R", toSpot: go.Spot.Right,fromSpot:go.Spot.Right,
                            fromLinkable: true,toLinkable: true})),
                $(go.Panel, "Horizontal", {row:2, column: 1},
                    $(go.Shape,  // the "B" port
                        {width: 3, height: 3, portId: "B", toSpot: go.Spot.Bottom,fromSpot:go.Spot.Bottom,
                            fromLinkable: true,toLinkable: true})),
                $(go.Panel, "Vertical",{row: 0, column: 1},
                    $(go.Shape,  // the "B" port
                        {width: 3, height: 3, portId: "U", toSpot: go.Spot.Top,fromSpot:go.Spot.Top,
                            fromLinkable: true,toLinkable: true}))
            );

        go.Shape.defineFigureGenerator("WeakEntity", function(shape, w, h) {
            var geo = new go.Geometry();
            var fig = new go.PathFigure(0.05*w,0.05*w, true);  // clockwise
            geo.add(fig);
            if (w>h){
                fig.add(new go.PathSegment(go.PathSegment.Line, 0.05*w,h-0.05*w)); //下划线到h点
                fig.add(new go.PathSegment(go.PathSegment.Line, 0.95*w,h-0.05*w));//在0.h 画到 1.6w,h
                fig.add(new go.PathSegment(go.PathSegment.Line, 0.95*w,0.05*w));
                fig.add(new go.PathSegment(go.PathSegment.Line, 0.05*w,0.05*w).close());

            }else{
                fig.add(new go.PathSegment(go.PathSegment.Line, 0.05*h,w-0.05*h)); //下划线到h点
                fig.add(new go.PathSegment(go.PathSegment.Line, 0.95*h,w-0.05*h));//在0.h 画到 1.6w,h
                fig.add(new go.PathSegment(go.PathSegment.Line, 0.95*h,0.05*h));
                fig.add(new go.PathSegment(go.PathSegment.Line, 0.05*h,0.05*h).close());

            }

            fig.add(new go.PathSegment(go.PathSegment.Move, 0,0));
            fig.add(new go.PathSegment(go.PathSegment.Line, 0,h));
            fig.add(new go.PathSegment(go.PathSegment.Line, w,h));
            fig.add(new go.PathSegment(go.PathSegment.Line, w,0));
            fig.add(new go.PathSegment(go.PathSegment.Line, 0,0));
            return geo;
        });

        // weak entity template
        const weakEntityTemplate =
            $(go.Node, "Table",  // the whole node panel
                {
                    locationObject: "BODY",
                    locationSpot:go.Spot.Center,
                    selectionObjectName: "BODY"
                },
                {
                    locationSpot: go.Spot.Center,
                    selectionAdorned: true,
                    resizable: false,
                    layoutConditions: go.Part.LayoutStandard & ~go.Part.LayoutNodeSized,
                    isShadowed: true,
                    shadowOffset: new go.Point(3, 3),
                    shadowColor: colors.lightblue,
                },
                new go.Binding("location", "location").makeTwoWay(),
                new go.Binding("desiredSize", "visible", v => new go.Size(NaN, NaN)).ofObject("LIST"),
                $(go.Panel,"Auto",
                    {
                        row: 1, column: 1, name: "BODY",
                    },
                    $(go.Shape, "WeakEntity",
                        {
                            fill: 'white',
                            portId: "",
                            stroke: colors.lightgrey,
                            cursor: "pointer",
                            fromSpot: go.Spot.AllSides,
                            toSpot: go.Spot.AllSides,
                            strokeWidth: 3,
                            fromLinkableDuplicates: false, toLinkableDuplicates: false,
                        }),
                    $(go.TextBlock, textStyle(),
                        {
                            row: 0, alignment: go.Spot.Center,
                            margin: new go.Margin(5, 24, 5, 2),  // leave room for Button
                            font: "bold 16px sans-serif",
                            editable: true
                        },
                        new go.Binding("text", "name").makeTwoWay()),
                ), //end Auto Panel Body
                // new go.Binding("fromLinkable", "from").makeTwoWay(), new go.Binding("toLinkable", "to").makeTwoWay()),
                $(go.Panel, "Vertical", {row: 1, column: 0},
                    $(go.Shape,
                        {width: 3, height: 3, portId: "L",
                            toSpot: go.Spot.Left,fromSpot:go.Spot.Left,
                            fromLinkable: true,toLinkable: true})),
                $(go.Panel, "Vertical", {row: 1, column: 2},
                    $(go.Shape,  // the "B" port
                        {width: 3, height: 3, portId: "R", toSpot: go.Spot.Right,fromSpot:go.Spot.Right,
                            fromLinkable: true,toLinkable: true})),
                $(go.Panel, "Horizontal", {row:2, column: 1},
                    $(go.Shape,  // the "B" port
                        {width: 3, height: 3, portId: "B", toSpot: go.Spot.Bottom,fromSpot:go.Spot.Bottom,
                            fromLinkable: true,toLinkable: true})),
                $(go.Panel, "Vertical",{row: 0, column: 1},
                    $(go.Shape,  // the "B" port
                        {width: 3, height: 3, portId: "U", toSpot: go.Spot.Top,fromSpot:go.Spot.Top,
                            fromLinkable: true,toLinkable: true}))
            );

        // subset template
        const subsetTemplate =
            $(go.Node, "Table",  // the whole node panel
                {
                    locationObject: "BODY",
                    locationSpot: go.Spot.Center,
                    selectionObjectName: "BODY",
                },
                {
                    locationSpot: go.Spot.Center,
                    selectionAdorned: true,
                    resizable: false,
                    layoutConditions: go.Part.LayoutStandard & ~go.Part.LayoutNodeSized,
                    isShadowed: true,
                    shadowOffset: new go.Point(3, 3),
                    shadowColor: colors.lightblue,
                },
                new go.Binding("location", "location").makeTwoWay(),
                new go.Binding("desiredSize", "visible", v => new go.Size(NaN, NaN)).ofObject("LIST"),
                // the table header
                $(go.Panel, "Auto",
                    {row: 1, column: 1, name: "BODY"},
                    $(go.Shape, "RoundedRectangle",
                        {
                            fill: colors.lightyellow,
                            portId: "",
                            stroke: colors.lightyellow,
                            cursor: "pointer",
                            fromSpot: go.Spot.AllSides,
                            toSpot: go.Spot.AllSides,
                            strokeWidth: 3,
                            fromLinkableDuplicates: false, toLinkableDuplicates: false
                        },
                        new go.Binding("fromLinkable", "from").makeTwoWay(), new go.Binding("toLinkable", "to").makeTwoWay()),
                    $(go.TextBlock,textStyle(),
                        {
                            row: 0, alignment: go.Spot.Center,
                            margin: new go.Margin(5, 24, 5, 2),  // leave room for Button
                            font: "bold 16px sans-serif",
                            editable: true
                        },
                        new go.Binding("text", "name").makeTwoWay()),
                    $(go.RowColumnDefinition, { row: 0, sizing: go.RowColumnDefinition.None }),
                ), // end Table Panel
                $(go.Panel, "Vertical", {row: 1, column: 0},
                    $(go.Shape,
                        {width: 3, height: 3, portId: "L",
                            toSpot: go.Spot.Left,fromSpot:go.Spot.Left,
                            fromLinkable: true,toLinkable: true})),
                $(go.Panel, "Vertical", {row: 1, column: 2},
                    $(go.Shape,  // the "B" port
                        {width: 3, height: 3, portId: "R", toSpot: go.Spot.Right,fromSpot:go.Spot.Right,
                            fromLinkable: true,toLinkable: true})),
                $(go.Panel, "Horizontal", {row:2, column: 1},
                    $(go.Shape,  // the "B" port
                        {width: 3, height: 3, portId: "B", toSpot: go.Spot.Bottom,fromSpot:go.Spot.Bottom,
                            fromLinkable: true,toLinkable: true})),
                $(go.Panel, "Vertical",{row: 0, column: 1},
                    $(go.Shape,  // the "B" port
                        {width: 3, height: 3, portId: "U", toSpot: go.Spot.Top,fromSpot:go.Spot.Top,
                            fromLinkable: true,toLinkable: true}))
            );

        // attribute template
        var attributeTemplate =$(go.Node, "Table",
            {
                locationObject: "BODY",
                locationSpot:go.Spot.Center,
                selectionObjectName: "BODY"
            },
            {
                selectionAdorned: true,
                resizable: false,
                layoutConditions: go.Part.LayoutStandard & ~go.Part.LayoutNodeSized
            },
            new go.Binding("location", "location").makeTwoWay(),
            $(go.Panel,"Auto",
                {row: 1, column: 1, name: "BODY"},
                $(go.Shape, "Circle",
                    {
                        fill: 'lightblue',
                        portId: "",
                        stroke: colors.lightblue,
                        cursor: "pointer",
                        fromSpot: go.Spot.AllSides,
                        toSpot: go.Spot.AllSides,
                        strokeWidth: 2,
                        fromLinkableDuplicates: false, toLinkableDuplicates: false
                    },
                    new go.Binding("fromLinkable", "from").makeTwoWay(),
                    new go.Binding("toLinkable", "to").makeTwoWay()),
                $(go.TextBlock,{
                        font: "bold 12px monospace",
                        margin: new go.Margin(0, 0, 0, 0),  // leave room for Button
                    },
                    new go.Binding("text","name").makeTwoWay(),
                    new go.Binding("isUnderline", "underline")
                )),
            $(go.Panel, "Vertical", {row: 1, column: 0},
                $(go.Shape,
                    {width: 3, height: 3, portId: "L",
                        toSpot: go.Spot.Left,fromSpot:go.Spot.Left,
                        fromLinkable: true,toLinkable: true})),
            $(go.Panel, "Vertical", {row: 1, column: 2},
                $(go.Shape,  // the "B" port
                    {width: 3, height: 3, portId: "R", toSpot: go.Spot.Right,fromSpot:go.Spot.Right,
                        fromLinkable: true,toLinkable: true})),
            $(go.Panel, "Horizontal", {row:2, column: 1},
                $(go.Shape,  // the "B" port
                    {width: 3, height: 3, portId: "B", toSpot: go.Spot.Bottom,fromSpot:go.Spot.Bottom,
                        fromLinkable: true,toLinkable: true})),
            $(go.Panel, "Vertical",{row: 0, column: 1},
                $(go.Shape,  // the "B" port
                    {width: 3, height: 3, portId: "U", toSpot: go.Spot.Top,fromSpot:go.Spot.Top,
                        fromLinkable: true,toLinkable: true}))
        );

        // add all node template
        var templateMap = new go.Map();
        // default template
        myDiagram.nodeTemplate = entityTemplate;
        templateMap.add("",entityTemplate);
        templateMap.add("Entity", entityTemplate);
        templateMap.add("WeakEntity", weakEntityTemplate);
        templateMap.add("Subset",subsetTemplate);
        templateMap.add("Attribute",attributeTemplate);

        templateMap.add("relation",relationTemplate);

        myDiagram.nodeTemplateMap = templateMap;

        // relation
        var relationLink = $(go.Link,  // the whole link panel
            {
                deletable: false,
                selectionAdorned: true,
                layerName: "Foreground",
                reshapable: true,
                routing: go.Link.AvoidsNodes,
                corner: 5,
                curve: go.Link.JumpOver,
                relinkableFrom: true,
                relinkableTo: true
            },
            $(go.Shape,  // the link shape
                {stroke: "#303B45", strokeWidth: 2.5 }),
            $(go.Panel, "Auto",  // this whole Panel is a link label
                $(go.Shape, "Diamond", {
                    fill: "yellow",
                    stroke: "gray",
                    width: 100,
                    height: 40}),
                $(go.TextBlock,  textStyle(),
                    {   margin: 3,
                        textAlign: "center",
                        segmentIndex: -2,
                        segmentOffset: new go.Point(NaN, NaN),
                        segmentOrientation: go.Link.OrientUpright,
                        font: "bold 14px sans-serif",
                        stroke: "#1967B3",
                    },
                    new go.Binding("text", "relation").makeTwoWay())
            ),
            $(go.TextBlock, textStyle(), // the "from" label
                {
                    textAlign: "center",
                    font: "bold 14px sans-serif",
                    stroke: "#1967B3",
                    segmentIndex: 0,
                    segmentOffset: new go.Point(NaN, NaN),
                    segmentOrientation: go.Link.OrientUpright
                },
                new go.Binding("text", "fromText").makeTwoWay()),
            $(go.TextBlock, textStyle(), // the "to" label
                {
                    textAlign: "center",
                    font: "bold 14px sans-serif",
                    stroke: "#1967B3",
                    segmentIndex: -1,
                    segmentOffset: new go.Point(NaN, NaN),
                    segmentOrientation: go.Link.OrientUpright
                },
                new go.Binding("text", "toText").makeTwoWay())
        );

        var normalLink = $(go.Link,
            {
                selectionAdorned: true,
                layerName: "Foreground",
                reshapable: true,
                routing: go.Link.AvoidsNodes,
                corner: 5,
                curve: go.Link.JumpOver,
                relinkableFrom: true,
                relinkableTo: true
            },
            $(go.Shape,  // the link shape
                {stroke: "#e8c446", strokeWidth: 2.5 }),
            $(go.TextBlock, textStyle(), // the "from" label
                {
                    textAlign: "center",
                    font: "bold 14px sans-serif",
                    stroke: "#1967B3",
                    segmentIndex: 0,
                    segmentOffset: new go.Point(NaN, NaN),
                    segmentOrientation: go.Link.OrientUpright
                },
                new go.Binding("text", "fromText").makeTwoWay()),
        );

        var subsetLink = $(go.Link,
            {
                deletable: false,
                selectionAdorned: true,
                layerName: "Foreground",
                reshapable: true,
                routing: go.Link.AvoidsNodes,
                corner: 5,
                curve: go.Link.JumpOver,
                relinkableFrom: true,
                relinkableTo: true
            },
            $(go.Shape,  // the link shape
                {stroke: "#e8c446", strokeWidth: 2.5 }),
            $(go.Shape,   // the arrowhead
                { toArrow: "OpenTriangle", fill: null, stroke:"#e8c446",strokeWidth:2.5}),
        );

        var entityLink = $(go.Link,
            {
                selectionAdorned: true,
                layerName: "Foreground",
                reshapable: true,
                routing: go.Link.AvoidsNodes,
                corner: 5,
                curve: go.Link.JumpOver,
                relinkableFrom: true,
                relinkableTo: true
            },
            $(go.Shape,  // the link shape
                {stroke: "#000000", strokeWidth: 2.5 }),
            $(go.TextBlock, textStyle(), // the "from" label
                {
                    textAlign: "center",
                    font: "bold 14px sans-serif",
                    stroke: "#1967B3",
                    segmentIndex: 0,
                    segmentOffset: new go.Point(NaN, NaN),
                    segmentOrientation: go.Link.OrientUpright
                },
                new go.Binding("text", "fromText").makeTwoWay()),

        );


        var linkTemplateMap = new go.Map();
        linkTemplateMap.add("relationLink", relationLink);
        linkTemplateMap.add("normalLink",normalLink);
        linkTemplateMap.add("subsetLink",subsetLink);
        linkTemplateMap.add("entityLink",entityLink);
        // default
        linkTemplateMap.add("",relationLink);
        myDiagram.linkTemplateMap = linkTemplateMap;

        myDiagram.model = new go.GraphLinksModel(
            { linkFromPortIdProperty: "fromPort",
                linkToPortIdProperty: "toPort",
                nodeDataArray: [],
                linkDataArray: []});
    }
</script>
</html>