<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/html">
<head><meta charset="UTF-8">
    <title>Create View</title>
    <link rel="stylesheet" type="text/css" href="css/dashboard.css">
    <link rel="stylesheet" type="text/css" href="css/menu.css">
    <script type = "text/javascript" src="js/go-debug.js"></script>
    <script type = "text/javascript" src="js/jquery-3.2.1.js"></script>
    <script src="https://unpkg.com/gojs@2.2.16/release/go.js"></script>
    <script src="https://unpkg.com/gojs@2.2.16/extensions/Figures.js"></script>
    <script src="./js/init.js?v=1.19"></script>
    <script src="./js/drawing.js?v=1.19"></script>

</head>
<body>
<nav>
    <!--			<img src="img/imageu.jpg" width="258" height="82" style = "float:left;">-->
    <ul class="nav_ul clear_fix">
        <li class="one"></li>
        <b>
            <li><a onclick="deleteView()"><span class="glyphicon glyphicon-thumbs-up" aria-hidden="true"></span>Delete View</a></li>
            <li><a onclick="drawView()"><span class="glyphicon glyphicon-cutlery" aria-hidden="true"></span>Save new sub-view</a></li>
            <li><a onclick="renameView()"><span class="glyphicon glyphicon-camera" aria-hidden="true"></span>Rename</a></li>
        </b>
    </ul>
</nav>


<div id="myDiagramDiv" class = "diagram"></div>

<!--<div class="platte" id="myPaletteDiv" >-->
<!--</div>-->

<!--侧边菜单栏-->
<div class="sidebar">
    <div class="design" id="entity1">
        <button class="sidebar-button" id="createEntity" onclick="createEntity()">
            <div class="navto-nav">Create Entity</div>
        </button>
    </div>
    <div class="design" id="entity2">
        <button class="sidebar-button" id="editEntity" onclick="openEditEntity()">
        <div class="navto-nav">Edit Entity</div>
        </button>
    </div>
    <div class="design" id="entity3">
        <button class="sidebar-button" id="deleteEntity" onclick="openDeleteEntity()">
            <div class="navto-nav">Delete Entity</div>
        </button>
    </div>
    <div class="design" id="attribute1">
        <button class="sidebar-button" id="addAttribute" onclick="openAddAttribute()">
            <div class="navto-nav">Add Attribute</div>
        </button>
    </div>
</div>

<!--Edit Entity Pop-->
<div id="popDiv">
    <div class="close">
        <a href="javascript:void(0)" onclick="closeEditEntity()">close</a>
    </div>
    <div>
        <input style="font-size: 12px" id="entityNameChoice" type="text" list="typelist" placeholder="please choose the Entity">
        <datalist class="entity-options" id="typelist">
        </datalist>
    </div>
    <div>
        <form method="get">
            <p style="font-size:12px;text-align: left">New Name: <input type="text" id="newEntityName"/></p>
            <input type="button" onclick="editEntity()" value="Submit"/>
        </form>
    </div>
</div>

<!--Delete Entity Pop-->
<div id="popDeleteDiv">
    <div class="close">
        <a href="javascript:void(0)" onclick="closeDeleteEntity()">close</a>
    </div>
    <div>
        <input style="font-size: 12px" id="deleteEntityNameChoice" type="text" list="typelist" placeholder="please choose the Entity">
        <datalist class="entity-options" id="deleteList">
        </datalist>
    </div>
    <div>
        <input type="button" onclick="deleteEntity()" value="Submit"/>
    </div>
</div>

<!--Add Attribute Pop-->
<div id="addAttributeDiv">
    <div class="close">
        <a href="javascript:void(0)" onclick="closeAddAttribute()">close</a>
    </div>
    <div>
        <input style="font-size: 12px" id="entityForAttributeNameChoice" type="text" list="typelist" placeholder="please choose the Entity">
        <datalist class="entity-options" id="entityList">
        </datalist>
    </div>
    <div>
        <form method="get">
            <p style="font-size:12px;text-align: left">Attribute Name: <input type="text" id="newAttributeName"/></p>
            <input type="button" onclick="addAttribute()" value="Submit"/>
        </form>
    </div>
</div>

<div class="banner"><div class="inner"></div></div>

<div id="buttons">
    <button id="loadButton" onclick="load()">Load</button>
    <button id="SaveButton" onclick="save()" disabled="">Save</button>
</div>

<textarea id="mySavedModel" style="width:100%;height:240px">
{ "class": "GraphLinksModel",
  "copiesArrays": true,
  "copiesArrayObjects": true,
  "nodeDataArray": [
{"key":3435,"name":"Products","location":{"class":"go.Point","x":-905.441681610523,"y":-29.922811407391464}, "from": true, "to":true},
{"key":34,"name":"Suppliers","location":{"class":"go.Point","x":-1472.350018298561,"y":-105.79224133183979}, "from": true, "to":true},
{"key":9340,"name":"Categories","location":{"class":"go.Point","x":-987.4442912524521,"y":-381.1624322383951}, "from": true, "to":true}
],
  "linkDataArray": [
{"key": 123, "from":3435,"to":34,"fromText":"0..N","toText":"1","relation":"has"},
{"key": 456,"from":3435,"to":9340,"fromText":"0..N","toText":"1","relation":"with"}
]}
</textarea>

<footer>ERAPI.Copyright ©2021 | Imperial college london-Group project</footer>

</body>
<script type = "text/javascript">
    $(function (){
        //hide all subtitle
        $(".nav_menu").each(function (){
            $(this).children(".nav_content").hide();

        });
        //add the click event of all the content
        $(".nav_title").each(function (){
            $(this).click(function (){
                var nav = $(this).parent(".nav_menu").children(".nav_content");
                if (nav.css("display")!="none"){
                    nav.slideUp();
                }else{
                    nav.slideDown();
                }
            });
        });
    });
</script>


<script id="code">
    /*
API 1: get all the entity and relationship
 */

    // var model ="";
    // var tmpString="";
    //
    // $.getJSON("getAllViewUrl", function(entities){
    // model = json_value;
    //
    // });

    function load() {
        myDiagram.model = go.Model.fromJson(document.getElementById("mySavedModel").value);
    }

    function save() {
        document.getElementById("mySavedModel").value = myDiagram.model.toJson();
        myDiagram.isModified = false;
    }
/*
 view operations
 */
    function drawView() {
        var new_name = prompt("Please enter new view name", "Draco");
        if (new_name != null && new_name != "") {
            $.getJSON("http://localhost:8000/drawView?" + "viewName=" + new_name+"&callback=?", function (res) {
                //todo 重定向 viewId param
                var viewId = res.id;
                window.location.replace("drawingView.html?name=" + new_name + "&id=" + viewId);
            }).fail(function (failure) {
                if (failure.status == 400) {
                    console.log("fail status:" + failure.status);
                }
            });
        }

    }

    function deleteView() {
        //todo offset
        let name = location.href.substring(location.href.indexOf("name=")+1,location.href.indexOf("id")-2);
        let id = location.href.substring(location.href.indexOf("id=")+1);


        $.getJSON("http://localhost:8000/deleteView?" + "&viewName=" +name+"&viewId=" + id+"&callback=?",function (res) {
        }).fail(function (failure) {
            if (failure.status == 400) {
                console.log("fail status:" + failure.status);
            }
        });
    }


    function renameView() {
        //todo offset
        let name = location.href.substring(location.href.indexOf("name=")+1,location.href.indexOf("id")-2);
        let id = location.href.substring(location.href.indexOf("id=")+1);

        var new_name = prompt("Please enter new view name", name);
        if (new_name != name && new_name != "" && new_name != null) {
            $.getJSON("http://localhost:8000/renameView?" + "id=" + id + "&viewName=" + name + "&newViewName=" +new_name+"&callback=?", function (res) {
            }).fail(function (failure) {
                if (failure.status == 400) {
                    console.log("fail status:" + failure.status);
                }
            });
            location.reload();
        }
    }

    window.addEventListener('DOMContentLoaded', init);
    addEntityOptions("datalist");
</script>
</html>